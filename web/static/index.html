<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrendHub ç®¡ç†å¹³å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <style>
        body { 
            background-color: #f3f4f6; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
        }
        
        /* ç»Ÿä¸€è¾“å…¥æ¡†æ ·å¼ */
        input[type="text"], 
        input[type="number"], 
        input[type="password"],
        select, 
        textarea {
            display: block;
            width: 100%;
            padding: 0.625rem 0.75rem;
            font-size: 0.875rem;
            line-height: 1.5;
            color: #374151;
            background-color: #fff;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        
        input[type="text"]:focus, 
        input[type="number"]:focus,
        input[type="password"]:focus,
        select:focus, 
        textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        input[type="checkbox"] {
            width: 1rem;
            height: 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            color: #6366f1;
            cursor: pointer;
        }
        
        input[type="checkbox"]:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        /* è¡¨å•æ ‡ç­¾ */
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }
        
        /* è¡¨å•ç»„ */
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        /* Fieldset æ ·å¼ */
        fieldset {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        fieldset legend {
            padding: 0 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            color: #111827;
        }
        
        /* å…³é”®è¯æ ‡ç­¾æ ·å¼ä¼˜åŒ– */
        .keyword-tag {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 0.875rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 9999px;
            cursor: default;
            transition: all 0.2s;
        }
        
        .keyword-tag:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .keyword-tag button {
            margin-left: 0.5rem;
            font-size: 1.125rem;
            font-weight: 600;
            line-height: 1;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .keyword-tag button:hover {
            transform: scale(1.2);
        }
        
        /* å…³é”®è¯è¾“å…¥æ¡† */
        .keyword-input {
            display: inline-block;
            width: 140px;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            background-color: transparent;
            border: 1px dashed #d1d5db;
            border-radius: 9999px;
            transition: all 0.2s;
        }
        
        .keyword-input:focus {
            outline: none;
            border-color: #6366f1;
            border-style: solid;
            background-color: #fff;
        }
        
        .keyword-input::placeholder {
            color: #9ca3af;
        }
        
        /* å…³é”®è¯ç»„å®¹å™¨ */
        .keyword-group {
            position: relative;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1.25rem;
            background-color: #f9fafb;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }
        
        .keyword-group:hover {
            border-color: #d1d5db;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .keyword-section-label {
            display: block;
            margin-bottom: 0.75rem;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #6b7280;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 0.375rem;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        /* ç½‘æ ¼å¯¹é½ä¼˜åŒ– */
        .grid-cols-1 {
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }
        
        @media (min-width: 640px) {
            .sm\:grid-cols-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
            .sm\:grid-cols-3 {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
            .sm\:grid-cols-6 {
                grid-template-columns: repeat(6, minmax(0, 1fr));
            }
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen flex flex-col">
        <!-- Navbar -->
        <nav class="bg-white shadow-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex">
                        <div class="flex-shrink-0 flex items-center">
                            <span class="text-xl font-bold text-indigo-600">TrendHub</span>
                        </div>
                        <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                            <a href="#" @click.prevent="currentTab = 'dashboard'" :class="tabClass('dashboard')" class="inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Dashboard</a>
                            <a href="#" @click.prevent="currentTab = 'config'" :class="tabClass('config')" class="inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">é…ç½®ç®¡ç†</a>
                            <a href="#" @click.prevent="currentTab = 'keywords'" :class="tabClass('keywords')" class="inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">å…³é”®è¯ç®¡ç†</a>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <span v-if="status.isRunning" class="inline-flex items-center px-3 py-0.5 rounded-full text-sm font-medium bg-green-100 text-green-800">
                            è¿è¡Œä¸­
                        </span>
                        <span v-else class="inline-flex items-center px-3 py-0.5 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
                            ç©ºé—²
                        </span>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Content -->
        <main class="flex-1 max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">
            
            <!-- Dashboard -->
            <div v-if="currentTab === 'dashboard'" class="space-y-6">
                <div class="bg-white shadow px-4 py-5 sm:rounded-lg sm:p-6">
                    <div class="md:grid md:grid-cols-3 md:gap-6">
                        <div class="md:col-span-1">
                            <h3 class="text-lg font-medium leading-6 text-gray-900">ä»»åŠ¡æ§åˆ¶</h3>
                            <p class="mt-1 text-sm text-gray-500">æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡çˆ¬å–ä»»åŠ¡ã€‚</p>
                        </div>
                        <div class="mt-5 md:mt-0 md:col-span-2 flex items-center space-x-4">
                            <button @click="runTask" :disabled="status.isRunning" 
                                class="btn text-white bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed">
                                <span v-if="status.isRunning">è¿è¡Œä¸­...</span>
                                <span v-else>ç«‹å³è¿è¡Œ</span>
                            </button>
                            <div class="text-sm text-gray-500">
                                ä¸Šæ¬¡è¿è¡Œ: {{ formatTime(status.lastRunTime) }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white shadow px-4 py-5 sm:rounded-lg sm:p-6">
                    <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">ä»»åŠ¡æ—¥å¿—</h3>
                    <div class="bg-gray-900 text-gray-100 p-4 rounded-md font-mono text-sm h-96 overflow-y-auto whitespace-pre-wrap">
                        {{ status.lastLog || 'æš‚æ— æ—¥å¿—' }}
                    </div>
                </div>
            </div>

            <!-- Config Editor (Form Based) -->
            <div v-if="currentTab === 'config'" class="bg-white shadow px-4 py-5 sm:rounded-lg sm:p-6">
                <div class="flex justify-between items-center mb-6 pb-4 border-b">
                    <h3 class="text-lg font-medium leading-6 text-gray-900">ç³»ç»Ÿé…ç½®</h3>
                    <div class="flex space-x-3">
                        <button @click="toggleConfigMode" class="text-sm text-indigo-600 hover:text-indigo-900 font-medium">
                            åˆ‡æ¢åˆ°{{ isRawConfig ? 'è¡¨å•' : 'æºç ' }}æ¨¡å¼
                        </button>
                        <button @click="saveConfig" class="btn text-white bg-indigo-600 hover:bg-indigo-700">
                            ä¿å­˜é…ç½®
                        </button>
                    </div>
                </div>

                <div v-if="!isRawConfig && configObj" class="space-y-6 overflow-y-auto max-h-[70vh] pr-2">
                    <!-- App Config -->
                    <fieldset>
                        <legend>åŸºç¡€è®¾ç½® (App)</legend>
                        <div class="grid grid-cols-1 gap-6 sm:grid-cols-6">
                            <div class="sm:col-span-4">
                                <label class="form-label">ç‰ˆæœ¬æ£€æŸ¥ URL</label>
                                <input type="text" v-model="configObj.app.version_check_url">
                            </div>
                            <div class="sm:col-span-2 flex items-end pb-2">
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" v-model="configObj.app.show_version_update" class="mr-2">
                                    <span class="text-sm font-medium text-gray-700">æ˜¾ç¤ºæ›´æ–°æç¤º</span>
                                </label>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Crawler Config -->
                    <fieldset>
                        <legend>çˆ¬è™«è®¾ç½® (Crawler)</legend>
                        <div class="grid grid-cols-1 gap-6 sm:grid-cols-6">
                            <div class="sm:col-span-2">
                                <label class="form-label">è¯·æ±‚é—´éš” (ms)</label>
                                <input type="number" v-model.number="configObj.crawler.request_interval">
                            </div>
                            <div class="sm:col-span-2 flex items-end pb-2">
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" v-model="configObj.crawler.enable_crawler" class="mr-2">
                                    <span class="text-sm font-medium text-gray-700">å¯ç”¨çˆ¬è™«</span>
                                </label>
                            </div>
                            <div class="sm:col-span-2 flex items-end pb-2">
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" v-model="configObj.crawler.use_proxy" class="mr-2">
                                    <span class="text-sm font-medium text-gray-700">å¯ç”¨ä»£ç†</span>
                                </label>
                            </div>
                            <div class="sm:col-span-6" v-if="configObj.crawler.use_proxy">
                                <label class="form-label">ä»£ç†åœ°å€</label>
                                <input type="text" v-model="configObj.crawler.default_proxy" placeholder="http://127.0.0.1:10086">
                            </div>
                        </div>
                    </fieldset>

                    <!-- Report Config -->
                    <fieldset>
                        <legend>æŠ¥å‘Šè®¾ç½® (Report)</legend>
                        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                            <div>
                                <label class="form-label">æ¨¡å¼</label>
                                <select v-model="configObj.report.mode">
                                    <option value="daily">å½“æ—¥æ±‡æ€» (daily)</option>
                                    <option value="current">å½“å‰æ¦œå• (current)</option>
                                    <option value="incremental">å¢é‡ç›‘æ§ (incremental)</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">æ’åé˜ˆå€¼</label>
                                <input type="number" v-model.number="configObj.report.rank_threshold">
                            </div>
                        </div>
                    </fieldset>

                    <!-- Notification Config -->
                    <fieldset>
                        <legend>é€šçŸ¥è®¾ç½® (Notification)</legend>
                        <div class="space-y-4">
                            <div class="mb-4">
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" v-model="configObj.notification.enable_notification" class="mr-2">
                                    <span class="text-sm font-medium text-gray-700">å¯ç”¨é€šçŸ¥</span>
                                </label>
                            </div>

                            <div v-if="configObj.notification.enable_notification" class="space-y-4">
                                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                    <h4 class="font-medium mb-4 text-gray-900">Webhooks</h4>
                                    <div class="grid grid-cols-1 gap-4">
                                        <div>
                                            <label class="form-label">é£ä¹¦ Webhook</label>
                                            <input type="text" v-model="configObj.notification.webhooks.feishu_url" placeholder="https://open.feishu.cn/open-apis/bot/v2/hook/...">
                                        </div>
                                        <div>
                                            <label class="form-label">é’‰é’‰ Webhook</label>
                                            <input type="text" v-model="configObj.notification.webhooks.dingtalk_url" placeholder="https://oapi.dingtalk.com/robot/send?access_token=...">
                                        </div>
                                        <div>
                                            <label class="form-label">ä¼ä¸šå¾®ä¿¡ Webhook</label>
                                            <input type="text" v-model="configObj.notification.webhooks.wework_url" placeholder="https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=...">
                                        </div>
                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                            <div>
                                                <label class="form-label">Telegram Bot Token</label>
                                                <input type="text" v-model="configObj.notification.webhooks.telegram_bot_token" placeholder="123456789:AAHfiqksKZ8...">
                                            </div>
                                            <div>
                                                <label class="form-label">Telegram Chat ID</label>
                                                <input type="text" v-model="configObj.notification.webhooks.telegram_chat_id" placeholder="-1001234567890">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                    <h4 class="font-medium mb-4 text-gray-900">é‚®ä»¶é€šçŸ¥</h4>
                                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                                        <div>
                                            <label class="form-label">å‘ä»¶äººé‚®ç®±</label>
                                            <input type="text" v-model="configObj.notification.webhooks.email_from" placeholder="sender@example.com">
                                        </div>
                                        <div>
                                            <label class="form-label">å¯†ç /æˆæƒç </label>
                                            <input type="password" v-model="configObj.notification.webhooks.email_password" placeholder="æˆæƒç æˆ–å¯†ç ">
                                        </div>
                                        <div class="sm:col-span-2">
                                            <label class="form-label">æ”¶ä»¶äººé‚®ç®± (é€—å·åˆ†éš”)</label>
                                            <input type="text" v-model="configObj.notification.webhooks.email_to" placeholder="user1@example.com,user2@example.com">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Weight Config -->
                    <fieldset>
                        <legend>æƒé‡ç®—æ³• (Weight)</legend>
                        <div class="grid grid-cols-1 gap-6 sm:grid-cols-3">
                            <div>
                                <label class="form-label">æ’åæƒé‡ (0-1)</label>
                                <input type="number" step="0.1" min="0" max="1" v-model.number="configObj.weight.rank_weight">
                            </div>
                            <div>
                                <label class="form-label">é¢‘æ¬¡æƒé‡ (0-1)</label>
                                <input type="number" step="0.1" min="0" max="1" v-model.number="configObj.weight.frequency_weight">
                            </div>
                            <div>
                                <label class="form-label">çƒ­åº¦æƒé‡ (0-1)</label>
                                <input type="number" step="0.1" min="0" max="1" v-model.number="configObj.weight.hotness_weight">
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-3">ğŸ’¡ æç¤ºï¼šä¸‰ä¸ªæƒé‡ä¹‹å’Œå»ºè®®ä¸º 1.0</p>
                    </fieldset>
                </div>

                <textarea v-else v-model="configYaml" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 font-mono text-sm p-4 bg-gray-50 min-h-[600px]" spellcheck="false"></textarea>
            </div>

            <!-- Keywords Editor (Table Based) -->
            <div v-if="currentTab === 'keywords'" class="bg-white shadow px-4 py-5 sm:rounded-lg sm:p-6">
                <div class="flex justify-between items-center mb-6 pb-4 border-b">
                    <h3 class="text-lg font-medium leading-6 text-gray-900">å…³é”®è¯é…ç½®</h3>
                    <div class="flex space-x-3">
                        <button @click="toggleKeywordMode" class="text-sm text-indigo-600 hover:text-indigo-900 font-medium">
                            åˆ‡æ¢åˆ°{{ isRawKeywords ? 'è¡¨æ ¼' : 'æºç ' }}æ¨¡å¼
                        </button>
                        <button @click="saveKeywords" class="btn text-white bg-indigo-600 hover:bg-indigo-700">
                            ä¿å­˜å…³é”®è¯
                        </button>
                    </div>
                </div>

                <div v-if="!isRawKeywords" class="space-y-4 overflow-y-auto max-h-[70vh]">
                    <div v-for="(group, idx) in keywordGroups" :key="idx" class="keyword-group">
                        <button @click="removeKeywordGroup(idx)" class="absolute top-3 right-3 text-red-500 hover:text-red-700 text-sm font-medium">åˆ é™¤</button>
                        
                        <div class="mb-4">
                            <label class="keyword-section-label">æ™®é€šè¯ (ä»»æ„åŒ¹é…)</label>
                            <div class="flex flex-wrap gap-2">
                                <span v-for="(word, wIdx) in group.normal" :key="wIdx" class="keyword-tag bg-blue-100 text-blue-800">
                                    {{ word }}
                                    <button @click="removeWord(group.normal, wIdx)" class="text-blue-600 hover:text-blue-900">Ã—</button>
                                </span>
                                <input type="text" placeholder="+ æ·»åŠ æ™®é€šè¯" @keydown.enter.prevent="addWord($event, group.normal)" class="keyword-input">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="keyword-section-label">å¿…é¡»è¯ (+)</label>
                            <div class="flex flex-wrap gap-2">
                                <span v-for="(word, wIdx) in group.required" :key="wIdx" class="keyword-tag bg-green-100 text-green-800">
                                    +{{ word }}
                                    <button @click="removeWord(group.required, wIdx)" class="text-green-600 hover:text-green-900">Ã—</button>
                                </span>
                                <input type="text" placeholder="+ æ·»åŠ å¿…é¡»è¯" @keydown.enter.prevent="addWord($event, group.required)" class="keyword-input">
                            </div>
                        </div>

                        <div>
                            <label class="keyword-section-label">è¿‡æ»¤è¯ (!)</label>
                            <div class="flex flex-wrap gap-2">
                                <span v-for="(word, wIdx) in group.filters" :key="wIdx" class="keyword-tag bg-red-100 text-red-800">
                                    !{{ word }}
                                    <button @click="removeWord(group.filters, wIdx)" class="text-red-600 hover:text-red-900">Ã—</button>
                                </span>
                                <input type="text" placeholder="+ æ·»åŠ è¿‡æ»¤è¯" @keydown.enter.prevent="addWord($event, group.filters)" class="keyword-input">
                            </div>
                        </div>
                    </div>

                    <button @click="addKeywordGroup" class="w-full py-3 border-2 border-dashed border-gray-300 rounded-md text-gray-600 hover:border-indigo-500 hover:text-indigo-500 font-medium text-sm transition-all">
                        + æ·»åŠ æ–°è¯ç»„
                    </button>
                </div>

                <div v-else>
                    <p class="text-sm text-gray-500 mb-3">ä½¿ç”¨ç©ºè¡Œåˆ†éš”ä¸åŒçš„å…³é”®è¯ç»„ã€‚!å¼€å¤´ä¸ºè¿‡æ»¤è¯ï¼Œ+å¼€å¤´ä¸ºå¿…é¡»è¯ã€‚</p>
                    <textarea v-model="keywordsContent" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 font-mono text-sm p-4 bg-gray-50 min-h-[600px]" spellcheck="false"></textarea>
                </div>
            </div>

        </main>
    </div>

    <script>
        const { createApp, ref, onMounted, onUnmounted } = Vue

        createApp({
            setup() {
                const currentTab = ref('dashboard')
                const status = ref({ isRunning: false, lastRunTime: '', lastLog: '' })
                
                // Config State
                const isRawConfig = ref(false)
                const configYaml = ref('')
                const configObj = ref(null)

                // Keywords State
                const isRawKeywords = ref(false)
                const keywordsContent = ref('')
                const keywordGroups = ref([])

                let pollTimer = null

                const tabClass = (tab) => {
                    return currentTab.value === tab 
                        ? 'border-indigo-500 text-gray-900'
                        : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                }

                const fetchStatus = async () => {
                    try {
                        const res = await fetch('/api/status')
                        const data = await res.json()
                        status.value = data
                    } catch (e) {
                        console.error(e)
                    }
                }

                const fetchConfig = async () => {
                    const res = await fetch('/api/config')
                    const data = await res.json()
                    configYaml.value = data.yaml
                    if (data.json) {
                        configObj.value = data.json
                    } else {
                        try {
                            configObj.value = jsyaml.load(data.yaml)
                        } catch (e) {
                            console.error('YAML parse error:', e)
                            isRawConfig.value = true
                        }
                    }
                }

                const fetchKeywords = async () => {
                    const res = await fetch('/api/keywords')
                    const data = await res.json()
                    keywordsContent.value = data.content
                    parseKeywords(data.content)
                }

                const parseKeywords = (text) => {
                    const groups = []
                    if (!text) return
                    
                    const rawGroups = text.split(/\n\s*\n/)
                    rawGroups.forEach(raw => {
                        if (!raw.trim()) return
                        const group = { normal: [], required: [], filters: [] }
                        const lines = raw.split('\n')
                        lines.forEach(line => {
                            line = line.trim()
                            if (!line) return
                            if (line.startsWith('!')) group.filters.push(line.substring(1))
                            else if (line.startsWith('+')) group.required.push(line.substring(1))
                            else group.normal.push(line)
                        })
                        groups.push(group)
                    })
                    keywordGroups.value = groups
                }

                const stringifyKeywords = () => {
                    return keywordGroups.value.map(group => {
                        const lines = []
                        group.normal.forEach(w => lines.push(w))
                        group.required.forEach(w => lines.push('+' + w))
                        group.filters.forEach(w => lines.push('!' + w))
                        return lines.join('\n')
                    }).join('\n\n')
                }

                const saveConfig = async () => {
                    try {
                        const payload = {}
                        if (isRawConfig.value) {
                            payload.content = configYaml.value
                        } else {
                            payload.jsonConfig = configObj.value
                        }

                        await fetch('/api/config', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        })
                        alert('âœ… é…ç½®å·²ä¿å­˜')
                        fetchConfig()
                    } catch (e) {
                        alert('âŒ ä¿å­˜å¤±è´¥: ' + e)
                    }
                }

                const saveKeywords = async () => {
                    try {
                        const content = isRawKeywords.value ? keywordsContent.value : stringifyKeywords()
                        await fetch('/api/keywords', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ content })
                        })
                        alert('âœ… å…³é”®è¯å·²ä¿å­˜')
                        fetchKeywords()
                    } catch (e) {
                        alert('âŒ ä¿å­˜å¤±è´¥: ' + e)
                    }
                }

                const toggleConfigMode = () => {
                    if (!isRawConfig.value) {
                        if (typeof jsyaml !== 'undefined') {
                            configYaml.value = jsyaml.dump(configObj.value)
                        }
                    } else {
                        try {
                            if (typeof jsyaml !== 'undefined') {
                                configObj.value = jsyaml.load(configYaml.value)
                            }
                        } catch (e) {
                            alert('YAML æ ¼å¼é”™è¯¯ï¼Œæ— æ³•åˆ‡æ¢åˆ°è¡¨å•æ¨¡å¼: ' + e.message)
                            return
                        }
                    }
                    isRawConfig.value = !isRawConfig.value
                }

                const toggleKeywordMode = () => {
                    if (!isRawKeywords.value) {
                        keywordsContent.value = stringifyKeywords()
                    } else {
                        parseKeywords(keywordsContent.value)
                    }
                    isRawKeywords.value = !isRawKeywords.value
                }

                const addKeywordGroup = () => {
                    keywordGroups.value.push({ normal: [], required: [], filters: [] })
                }

                const removeKeywordGroup = (idx) => {
                    keywordGroups.value.splice(idx, 1)
                }

                const addWord = (e, list) => {
                    const val = e.target.value.trim()
                    if (val) {
                        list.push(val)
                        e.target.value = ''
                    }
                }

                const removeWord = (list, idx) => {
                    list.splice(idx, 1)
                }

                const runTask = async () => {
                    try {
                        await fetch('/api/run', { method: 'POST' })
                        fetchStatus()
                    } catch (e) {
                        alert('å¯åŠ¨å¤±è´¥: ' + e)
                    }
                }

                const formatTime = (t) => {
                    if (!t || t.startsWith('0001')) return 'ä»æœªè¿è¡Œ'
                    return new Date(t).toLocaleString()
                }

                onMounted(() => {
                    fetchStatus()
                    fetchConfig()
                    fetchKeywords()
                    pollTimer = setInterval(fetchStatus, 2000)
                })

                onUnmounted(() => {
                    if (pollTimer) clearInterval(pollTimer)
                })

                return {
                    currentTab,
                    status,
                    isRawConfig, configYaml, configObj, toggleConfigMode,
                    isRawKeywords, keywordsContent, keywordGroups, toggleKeywordMode,
                    addKeywordGroup, removeKeywordGroup, addWord, removeWord,
                    tabClass,
                    saveConfig,
                    saveKeywords,
                    runTask,
                    formatTime
                }
            }
        }).mount('#app')
    </script>
</body>
</html>
